# دليل رفع الصور في الفواتير

## الميزات الجديدة

### 1. رفع الصور مع القص والضغط
- **رفع الصور**: يمكن رفع صور القماش مباشرة في الفاتورة
- **قص الصور**: إمكانية قص الصورة لتحديد المنطقة المطلوبة
- **ضغط تلقائي**: ضغط الصور للحفاظ على المساحة مع الحفاظ على الجودة
- **تخزين آمن**: رفع الصور إلى Supabase Storage

### 2. المكونات المضافة

#### أ. `ImageUploadWithCrop.tsx`
- مكون رفع الصور مع إمكانية القص
- واجهة سهلة الاستخدام
- دعم السحب والإفلات
- معاينة الصورة قبل الحفظ

#### ب. `ImageService.ts`
- خدمة إدارة الصور
- ضغط الصور تلقائياً
- رفع وحذف الصور
- إنشاء صور مصغرة

### 3. الخطوات المطلوبة

#### أ. إعداد Supabase Storage
1. اذهب إلى Supabase Dashboard
2. Storage > Create Bucket
3. اسم الـ Bucket: `invoice-images`
4. Public: Yes
5. File size limit: 50MB

#### ب. تطبيق تحديث قاعدة البيانات
```sql
-- انسخ والصق محتوى ملف add-fabric-image-column.sql في Supabase SQL Editor
```

#### ج. إعداد السياسات (RLS)
```sql
-- سياسة للسماح بقراءة الصور
CREATE POLICY "Allow public read access to images" 
ON storage.objects FOR SELECT 
USING (bucket_id = 'invoice-images');

-- سياسة للسماح بكتابة الصور للمستخدمين المسجلين
CREATE POLICY "Allow authenticated users to upload images" 
ON storage.objects FOR INSERT 
TO authenticated 
WITH CHECK (bucket_id = 'invoice-images');

-- سياسة للسماح بحذف الصور
CREATE POLICY "Allow users to delete their own images" 
ON storage.objects FOR DELETE 
TO authenticated 
USING (bucket_id = 'invoice-images');
```

### 4. كيفية الاستخدام

#### أ. رفع صورة جديدة
1. اذهب إلى إنشاء فاتورة جديدة
2. في قسم "ملاحظات وصور"
3. اضغط على "اختيار صورة"
4. اختر الصورة من الجهاز

#### ب. قص الصورة
1. بعد اختيار الصورة، اضغط "قص الصورة"
2. اسحب لتحديد المنطقة المطلوبة
3. اضغط "قص وحفظ"

#### ج. حذف الصورة
- اضغط "حذف الصورة" لإزالة الصورة المحددة

### 5. الميزات التقنية

#### أ. ضغط الصور
- **الحد الأقصى للعرض**: 1200px
- **نسبة الضغط**: 85% (جودة عالية)
- **الصيغة**: JPEG
- **الحد الأقصى للحجم**: 5MB

#### ب. تخزين الصور
- **المجلد**: `fabric-images/`
- **اسم الملف**: `timestamp-randomstring.jpg`
- **الوصول**: Public URL
- **الأمان**: RLS policies

#### ج. دعم الصيغ
- **JPEG**: مدعوم بالكامل
- **PNG**: مدعوم بالكامل  
- **WebP**: مدعوم بالكامل

### 6. استكشاف الأخطاء

#### أ. مشكلة رفع الصورة
```
الخطأ: "فشل في رفع الصورة"
الحل: تأكد من إعداد Supabase Storage bucket
```

#### ب. مشكلة حجم الصورة
```
الخطأ: "حجم الملف كبير جداً"
الحل: الصورة ستُضغط تلقائياً
```

#### ج. مشكلة صيغة الصورة
```
الخطأ: "نوع الملف غير مدعوم"
الحل: استخدم JPEG, PNG, أو WebP
```

### 7. اختبار الميزة

#### أ. اختبار رفع الصورة
1. اذهب إلى إنشاء فاتورة
2. ارفع صورة قماش
3. تأكد من ظهور الصورة
4. احفظ الفاتورة
5. تحقق من حفظ رابط الصورة

#### ب. اختبار قص الصورة
1. ارفع صورة كبيرة
2. اضغط "قص الصورة"
3. حدد المنطقة المطلوبة
4. اضغط "قص وحفظ"
5. تأكد من حفظ الصورة المقصوصة

### 8. الملفات المحدثة

#### أ. المكونات الجديدة
- `src/components/ui/ImageUploadWithCrop.tsx`
- `src/services/image.service.ts`

#### ب. الملفات المحدثة
- `src/components/NewInvoiceDialog.tsx`
- `src/services/invoice.service.ts`
- `src/db/database.service.ts`

#### ج. ملفات قاعدة البيانات
- `add-fabric-image-column.sql`

### 9. ملاحظات مهمة

- **الأمان**: الصور محمية بـ RLS policies
- **الأداء**: الصور مضغوطة للحفاظ على السرعة
- **التوافق**: يعمل مع جميع المتصفحات الحديثة
- **النسخ الاحتياطي**: الصور محفوظة في Supabase Storage

### 10. الدعم الفني

إذا واجهت أي مشاكل:
1. تحقق من إعدادات Supabase Storage
2. تأكد من تطبيق SQL scripts
3. تحقق من console المتصفح للأخطاء
4. تأكد من صحة متغيرات البيئة
